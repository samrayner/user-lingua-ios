#!/bin/sh
set -e

BASE_DIR="$(readlink -f $0 | xargs dirname)"
BUILD_DIR="$BASE_DIR/.build"
SCIPIO_GIT_URL=https://github.com/giginet/Scipio.git
SCIPIO_GIT_TAG=0.18.2
SCIPIO_GIT_DIR="$BASE_DIR/.build/scipio"
SCIPIO_BIN="$SCIPIO_GIT_DIR/.build/release/scipio"
SDK_DIR="$BASE_DIR/FlatSDK"
FRAMEWORKS_DIR="$BASE_DIR/Frameworks"

message() {
  echo "\n\033[1;32m‚ñ∂ $1\033[0m\n"
}

message "üßπ Prepare build directory"

if [ ! -d "$BUILD_DIR" ]; then
  mkdir -p "$BUILD_DIR"
fi

if [ ! -d "$SCIPIO_GIT_DIR" ]; then
  message "‚¨áÔ∏è Fetch Scipio"
  git clone --depth 1 --branch "$SCIPIO_GIT_TAG" "$SCIPIO_GIT_URL" "$SCIPIO_GIT_DIR"

  message "üèóÔ∏è Build Scipio"
  (cd "$SCIPIO_GIT_DIR"; swift build -c release)
fi

message "üèóÔ∏è Build XCFrameworks"
"$SCIPIO_BIN" create\
  "$SDK_DIR"\
  --output "$FRAMEWORKS_DIR"\
  --configuration release\
  --embed-debug-symbols\
  --support-simulators\
  --overwrite\
  --platforms iOS\
  --enable-library-evolution\
  --static

message "‚úÖ Done"
